<!DOCTYPE html>
<html>
<head>
    <title>Camera Feed Test</title>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
</head>
<body>
    <h1>Camera Feed Connection Test</h1>
    <div id="status">Connecting...</div>
    <div id="topics"></div>
    <canvas id="canvas" width="640" height="480" style="border: 1px solid black;"></canvas>
    
    <script>
        const ros = new ROSLIB.Ros({
            url: 'ws://localhost:9090'
        });

        const statusDiv = document.getElementById('status');
        const topicsDiv = document.getElementById('topics');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        ros.on('connection', function() {
            statusDiv.innerHTML = 'Connected to ROS!';
            console.log('Connected to websocket server.');
            
            // Try alternative method to get topics using service call
            const topicsService = new ROSLIB.Service({
                ros: ros,
                name: '/rosapi/topics',
                serviceType: 'rosapi/Topics'
            });

            const request = new ROSLIB.ServiceRequest({});
            
            topicsService.callService(request, function(result) {
                console.log('Available topics via service:', result);
                const topics = result.topics || [];
                topicsDiv.innerHTML = '<h3>Available Topics (' + topics.length + '):</h3><ul>' + 
                    topics.map(topic => `<li>${topic}</li>`).join('') + 
                    '</ul>';
                
                // Check if our camera topic exists
                if (topics.includes('/zed/zed_node/rgb/image_rect_color')) {
                    console.log('Found camera topic in service result!');
                    subscribeToCamera();
                } else {
                    console.log('Camera topic not found in service result');
                    console.log('Available topics:', topics);
                    // Try subscribing anyway
                    console.log('Trying to subscribe anyway...');
                    subscribeToCamera();
                }
            }, function(error) {
                console.error('Failed to get topics via service:', error);
                // Try direct subscription anyway
                console.log('Service failed, trying direct subscription...');
                subscribeToCamera();
            });
        });

        ros.on('error', function(error) {
            statusDiv.innerHTML = 'Error connecting to ROS: ' + error;
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function() {
            statusDiv.innerHTML = 'Connection to ROS closed.';
            console.log('Connection to websocket server closed.');
        });

        function subscribeToCamera() {
            console.log('Subscribing to camera topic...');
            
            const imageTopic = new ROSLIB.Topic({
                ros: ros,
                name: '/zed/zed_node/rgb/image_rect_color',
                messageType: 'sensor_msgs/Image'
            });

            imageTopic.subscribe(function(message) {
                console.log('Received image message:', {
                    width: message.width,
                    height: message.height,
                    encoding: message.encoding,
                    dataType: typeof message.data,
                    dataLength: message.data ? message.data.length : 'undefined'
                });
                
                statusDiv.innerHTML = 'Receiving camera data! ' + new Date().toLocaleTimeString();
                
                // Try to draw the image
                try {
                    drawImage(message);
                } catch (error) {
                    console.error('Error drawing image:', error);
                }
            });
            
            console.log('Subscribed to camera topic');
        }

        function drawImage(imageMessage) {
            const { width, height, encoding, data } = imageMessage;
            
            // Set canvas size
            canvas.width = width;
            canvas.height = height;
            
            if (!data) {
                console.error('No image data received');
                return;
            }
            
            console.log('Drawing image:', { width, height, encoding });
            
            // Create a simple test pattern if we can't decode the image
            const imageData = ctx.createImageData(width, height);
            
            // Fill with a test pattern
            for (let i = 0; i < imageData.data.length; i += 4) {
                imageData.data[i] = 255;     // R
                imageData.data[i + 1] = 0;   // G
                imageData.data[i + 2] = 0;   // B
                imageData.data[i + 3] = 255; // A
            }
            
            ctx.putImageData(imageData, 0, 0);
            console.log('Test pattern drawn');
        }
    </script>
</body>
</html>
